<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contact Us</title>
  <link rel="stylesheet" href="styles.css">

  <!-- CloudWatch RUM -->
  <script>
    (function (n, i, v, r, s, c, x, z) {
      x = window.AwsRumClient = { q: [], n: n, i: i, v: v, r: r, c: c };
      window[n] = function (c, p) { x.q.push({ c: c, p: p }); };
      z = document.createElement('script');
      z.async = true;
      z.src = s;
      document.head.insertBefore(z, document.head.getElementsByTagName('script')[0]);
    })(
      'cwr',
      'd2d79b22-23df-4bb7-9b86-a0294e07bcf4',
      '1.0.0',
      'us-east-1',
      'https://client.rum.us-east-1.amazonaws.com/1.13.6/cwr.js',
      {
        sessionSampleRate: 1,
        guestRoleArn: "arn:aws:iam::382625484581:role/RUM-Monitor-us-east-1-382625484581-9467346556861-Unauth",
        identityPoolId: "us-east-1:a18b344d-74fc-4759-aae9-e09be65e7c49",
        endpoint: "https://dataplane.rum.us-east-1.amazonaws.com",
        telemetries: ["performance", "errors", "http"],
        allowCookies: true,
        enableXRay: true
      }
    );
  </script>

  <!-- Google Tag Manager -->
  <script>
    setTimeout(function () {
      var script = document.createElement('script');
      script.src = 'https://www.googletagmanager.com/gtag/js?id=G-72726HN0SL';
      script.async = true;
      document.head.appendChild(script);
      script.onload = function () {
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-72726HN0SL');
      };
    }, 5000);
  </script>

  <!-- Leadgen CDN -->
  <script src="https://lhg-dev.cdn.leadgen.pennysaver.in/HostingSwapJS/932895671/swap.js"></script>

  <!-- Amazon Connect Chat -->
  <script type="text/javascript">
    (function (w, d, x, id) {
      const s = d.createElement('script');
      s.src = 'https://dtn7rvxwwlhud.cloudfront.net/amazon-connect-chat-interface-client.js'; // Verify this URL
      s.async = 1;
      s.id = id;
      s.onload = () => {
        console.log('Amazon Connect script loaded successfully');
        initAmazonConnect();
      };
      s.onerror = () => {
        console.error('Failed to load Amazon Connect script');
        displayError('Unable to load chat service. Please check your network and try again.');
      };
      d.getElementsByTagName('head')[0].appendChild(s);
      w[x] = w[x] || function () { (w[x].ac = w[x].ac || []).push(arguments) };
    })(window, document, 'amazon_connect', '2bbef40d-4c62-4aaa-902e-f999367c5a58');

    function initAmazonConnect() {
      if (typeof amazon_connect === 'undefined') {
        console.error('Amazon Connect library not loaded');
        displayError('Chat service unavailable. Please try again later.');
        return;
      }

      amazon_connect('styles', { 
        iconType: 'CHAT', 
        openChat: { color: '#000', backgroundColor: '#3498fe' }, 
        closeChat: { color: '#fff', backgroundColor: '#123456' } 
      });

      amazon_connect('snippetId', 'QVFJREFIaWFZYXRVSlpIekdkUUg5YXhZenVQMktKRXNIWTVFQWpBYVErTEdzRnpvZHdFYkM5cU9Bc1NKeU9jRlZZM0hEM1pIQUFBQWJqQnNCZ2txaGtpRzl3MEJCd2FnWHpCZEFnRUFNRmdHQ1NxR1NJYjNEUUVIQVRBZUJnbGdoa2dCWlFNRUFTNHdFUVFNVjgwdlBWUjNrbVU5N3pUb0FnRVFnQ3VxbzVBbjk2bTBOQlgzdWM5eHdyWmVTQVRzT0RkakFyL3IzLzNDSmRDenBHU0NnYWtmZldaUWM4YTk6OldFbkhUOTJsZmpkWXRaL3ozSzdsN2ZOZS8rei81S2VhQklRdCtIYWhteXNER0hydVFFQ2QvalRxQk1Ub0kzcU1KQXZtUHQvZlVpU3l4Yms2OUN2S1ByMk9xK04xMCtaQXJIc1k3Um1oN1M1a2I0UGVZay9YSUtVWGZ1M1JzSFFQSFNsRjRlVHU1TEpaV0U0bWVFUDdwaHBKcyswZjQyUT0=');

      amazon_connect('supportedMessagingContentTypes', [
        'text/plain', 
        'text/markdown', 
        'application/vnd.amazonaws.connect.message.interactive', 
        'application/vnd.amazonaws.connect.message.interactive.response'
      ]);

      amazon_connect('authenticationParameters', {
        redirectUri: 'https://www.dev.chatbot.pennysaver.in', // Ensure this matches Cognito callback URL
        identityProvider: 'COGNITO'
      });

      amazon_connect('onChatInitialized', () => {
        console.log('Chat initialized successfully.');
      });

      amazon_connect('registerCallback', {
        'AUTHENTICATION_INITIATED': (eventName, data) => {
          console.log('Auth initiated - opening popup:', data.signInUrl);
          sessionStorage.setItem('cognitoAuthState', data.state);
          const popup = window.open(data.signInUrl, 'cognitoAuthPopup', 'width=600,height=600');
          if (!popup) {
            console.error('Failed to open popup. Please allow popups for this site.');
            displayError('Please allow popups to authenticate.');
          }
        },
        'AUTHENTICATION_SUCCESSFUL': (eventName, data) => {
          console.log('Auth successful - user profile:', data);
          amazon_connect('startChat', {
            contactId: data.contactId, // Adjust based on response
            participantId: data.participantId
          });
        },
        'AUTHENTICATION_FAILED': (eventName, data) => {
          console.error('Auth failed:', data);
          displayError('Authentication failed. Please try again.');
        }
      });
    }

    const handleAuthCallback = () => {
      const urlParams = new URLSearchParams(window.location.search);
      const authCode = urlParams.get('code');
      const state = urlParams.get('state');
      const error = urlParams.get('error');
      const errorDescription = urlParams.get('error_description');
      const storedState = sessionStorage.getItem('cognitoAuthState');

      if (authCode && state) {
        if (state !== storedState) {
          console.error('State mismatch! Potential CSRF attack.', { received: state, expected: storedState });
          displayError('Authentication failed due to state mismatch.');
          return;
        }

        if (typeof amazon_connect === 'undefined') {
          console.error('Amazon Connect library not loaded');
          displayError('Chat service unavailable.');
          return;
        }

        console.log('Processing authentication callback with code:', authCode);
        amazon_connect('updateParticipantAuthentication', {
          Code: authCode,
          State: state,
        }, (response, error) => {
          if (error) {
            console.error('updateParticipantAuthentication failed:', error);
            displayError('Failed to update authentication. Please try again.');
            return;
          }
          console.log('updateParticipantAuthentication response:', response);
          if (window.opener) {
            window.opener.postMessage({ 
              type: 'COGNITO_AUTH_COMPLETE', 
              success: true 
            }, 'https://www.dev.chatbot.pennysaver.in');
            window.close();
          } else {
            window.location.href = 'https://www.dev.chatbot.pennysaver.in?auth=success';
          }
        });
      } else if (error) {
        console.error('Authentication error:', error, errorDescription);
        if (typeof amazon_connect !== 'undefined') {
          amazon_connect('updateParticipantAuthentication', {
            Error: error,
            ErrorDescription: errorDescription || 'Authentication failed',
            State: state || 'UNKNOWN_STATE'
          }, (response, error) => {
            if (error) {
              console.error('updateParticipantAuthentication failed:', error);
            }
          });
        }
        displayError(`Authentication failed: ${errorDescription || 'Unknown error'}`);
      }
    };

    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('code') || urlParams.has('error')) {
        handleAuthCallback();
      }
    });

    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://www.dev.chatbot.pennysaver.in') {
        console.warn('Invalid origin for message:', event.origin);
        return;
      }
      if (event.data.type === 'COGNITO_AUTH_COMPLETE') {
        console.log('Received auth completion message from popup');
        // Optionally verify authentication state
      }
    });

    function displayError(message) {
      alert(message); // Replace with your UI error handling (e.g., modal)
    }
  </script>
</head>
<body>
  <div class="header">
    <h1>Home Gaurd</h1>
  </div>

  <div class="container">
    <div class="hero">
      <h1>Simplify Home Ownership with a Home Warranty</h1>
      <p>Protect your home’s most valuable systems and appliances. Starting at $1/day.</p>
      <button>ENTER YOUR ZIP CODE</button>
      <button>CHECK OUR PRICES</button>
    </div>

    <div class="contact-section">
      <h2>Get Covered in Minutes</h2>
      <p>Guard your systems, appliances—or for our best value—both. Starting at $1/day.</p>
      <button>Submit a Claim</button>
    </div>
    <div class="contact-section">
      First American Home Warranty Pool <a class="number" href="tel:+18888750533">+1 888-875-0533</a><br>
      Old Republic Insurance Group Pool <a class="number" href="tel:+18669284082">+1 866-928-4082</a><br>
      Earl's Home Warranty <a class="number" href="tel:+18063292723">+1 806-329-2723</a><br>
      Elite home warranties <a class="number" href="tel:+18883548398">+1 888-354-8398</a><br>
      Cinch Home Services <a class="number" href="tel:+18443830859">+1 844-383-0859</a><br>
      Dev Liberty Home Guard Pool <a class="number" href="tel:+19841677880">+1 984-167-7880</a><br>
      American Home Shield Pool <a class="number" href="tel:+18553888085">+1 855-388-8085</a><br>
      2-10 Home Buyers Warranty Pool <a class="number" href="tel:+18004146780">+1 800-414-6780</a>
    </div>

    <div class="contact-section">
      <h2>Help is on the Way</h2>
      <p>Pay your service call fee and manage your claim online. We’ll try to have a technician to you within 24-48 hours*.</p>
      <p>*majority of claims have a technician on site within 24-48 business hours.</p>
    </div>

    <div class="contact-section">
      <h2>What is a Home Warranty?</h2>
      <p>A home warranty is a service contract that covers repair and replacement costs when your home’s systems and appliances break down due to normal wear and tear...</p>
      <!-- Truncated for brevity -->
    </div>
  </div>

  <div class="footer">
    <p>
      © 2023 Your Website. All rights reserved. |
      <a href="#">Privacy Policy</a> |
      <a href="#">Terms of Service</a> |
      Contact Us:
      Test Number 1 <a class="number" href="tel:+19841677880">+1 984-167-7880</a>
      Test Number 2 <a class="number" href="tel:+19092307075">+1 909-230-7075</a>
    </p>
  </div>
</body>
</html>